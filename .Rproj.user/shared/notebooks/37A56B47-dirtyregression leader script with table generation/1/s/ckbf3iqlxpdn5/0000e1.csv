"0","#table processing  "
"0","dirtyregressionresults <- as.data.frame(c())"
"0",""
"0","#Parsing Grouping Chunks "
"0","ChunkStarts <- which(grepl(""D1"", CleanData$TAG))"
"0","print(ChunkStarts)"
"1"," [1]"
"1","  14"
"1","  26"
"1","  38"
"1","  50"
"1","  62"
"1"," 101"
"1"," 113"
"1"," 125"
"1"," 137"
"1"," 149"
"1"," 191"
"1"," 209"
"1"," 221"
"1"," 257"
"1"," 269"
"1"," 281"
"1"," 293"
"1"," 305"
"1"," 344"
"1"," 359"
"1"," 371"
"1"," 413"
"1"," 425"
"1"," 437"
"1"," 449"
"1","
"
"1","[26]"
"1"," 491"
"1"," 506"
"1"," 518"
"1"," 572"
"1"," 611"
"1"," 623"
"1"," 635"
"1"," 689"
"1"," 731"
"1"," 743"
"1"," 755"
"1"," 800"
"1"," 812"
"1"," 860"
"1"," 872"
"1"," 929"
"1","
"
"0","#ChunkStarts <- ChunkStarts[1:5]"
"0","w <- 26"
"0",""
"0","for (w in ChunkStarts){"
"0","  w <- as.numeric(w)"
"0","tempterm <- w+9"
"0","ProcessingSubset <- CleanData %>% slice(w:tempterm)"
"0",""
"0","{"
"0","#Find Negative Controls"
"0","tempterm <- ProcessingSubset$CELL_LINE_NAME[2]"
"0","tempvector <- which(grepl(tempterm, CleanData$CELL_LINE_NAME))"
"0","tempdata <- CleanData %>% slice(min(tempvector):max(tempvector))"
"0","tempdata <- cbind(tempdata, tempvector)"
"0","tempdata <- tempdata %>% filter(tempdata$TAG == ""NC-0"")"
"0","NC0 <- mean(tempdata$INTENSITY)"
"0","#Normalization Calculations"
"0","tempdata <- ProcessingSubset[""CONC""]"
"0","tempdata <- cbind(tempdata, ProcessingSubset[""INTENSITY""])"
"0","tempdata[tempdata == ""NA""] <- ""0"""
"0","tempdata <- as.data.frame(tempdata)"
"0","tempvector <- as.vector(tempdata$INTENSITY)"
"0","ProcessingSubset$CONC <- as.numeric(ProcessingSubset$CONC)"
"0","ProcessingSubset[""lnCONC""] <- log(ProcessingSubset[""CONC""])"
"0","ProcessingSubset[""RELATIVE_VIABILITY""] <- (tempvector - 30000)/(NC0 - 30000)"
"0","#Import Data - Change Name for different tables of Cell/Drug Combos "
"0","equation_test_data <- ProcessingSubset[1:10,3:4]"
"0","equation_test_data <- cbind(equation_test_data, ProcessingSubset[1:10,12:15])"
"0","equation_test_data[equation_test_data == ""Inf""] <- 10"
"0","equation_test_data[equation_test_data == ""-Inf""] <- -10"
"0","ActiveName <- paste(equation_test_data$CELL_LINE_NAME[1],equation_test_data$DRUG_ID[2], sep=""_"")"
"0","print(paste(ActiveName))"
"0","# Data Prep"
"0","x <- equation_test_data$CONC"
"0","y <- equation_test_data$RELATIVE_VIABILITY "
"0","} #general processing and data collection"
"0","if (sd(x) <= 0){"
"0","  tempvector <- c(ActiveName, ""No Drug"", 0, 0, 0, 0, NA, NA)"
"0","  dirtyregressionresults <- rbind(dirtyregressionresults, tempvector)"
"0","  next"
"0","  } "
"0","if (sd(y) <= .03){"
"0","  tempvector <- c(ActiveName, ""Not Effective"", 0, 0, 0, 0, NA, Inf)"
"0","  dirtyregressionresults <- rbind(dirtyregressionresults, tempvector)"
"0","  next "
"0","  } "
"0","{"
"0","testdata <- as.data.frame(x)"
"0","testdata <- cbind(testdata, y)"
"0","testdata[testdata == ""Inf""] <- 10"
"0","testdata[testdata == ""-Inf""] <- -10"
"0","testdata <- as.data.frame(testdata)"
"0","}"
"0","{#Biphasic Model Regression Calculations ------------------------"
"0","#inputs"
"0","{activefunction <- function(x) {1-a*x/(b+x)-(1-a)*x/(c+x)}"
"0","offset.activefunction <- function(x) {1-a*(x-d)/(b+(x-d))-(1-a)*(x-d)/(c+(x-d))}"
"0","biphasic.function <- activefunction"
"0","x <- testdata$x"
"0","y <- testdata$y"
"0","z <- c(0:10)  #iterations"
"0","s <- 3       #Number of subdivisions to do during regression"
"0","a <- c(-1,1)  #F1 term"
"0","b <- c(-1,10) #Kd1"
"0","c <- c(-1,10) #Kd2"
"0","d <- NA #currently the offset for when Imax is reached"
"0","}"
"0","source(file = ""dirtyregression.R"", local = TRUE)"
"0","}"
"0","{#outputs"
"0","biphasic.results <- results[order(results$RMSEscore), ] [1,]"
"0","a <- as.numeric(biphasic.results$a)"
"0","b <- as.numeric(biphasic.results$b)"
"0","c <- as.numeric(biphasic.results$c)"
"0","RMSE <- as.numeric(biphasic.results$RMSEscore)#"
"0","}"
"0","{#Calculate IC50"
"0","tempterm <- 0.5*(2*a*b - b - 2*a*c + c + sqrt((-2*a*b + b + 2*a*c - c)^2 + 4*b*c))"
"0","tempterm2 <- 0.5*(2*a*b - b - 2*a*c + c - sqrt((-2*a*b + b + 2*a*c - c)^2 + 4*b*c))"
"0","IC50 <- max(tempterm, tempterm2)"
"0","}"
"0","{"
"0","#Construct Results CSV"
"0","tempvector <- c(ActiveName, ""Biphasic Model"", a, b, c, d, RMSEscore, IC50)"
"0","dirtyregressionresults <- rbind(dirtyregressionresults, tempvector)"
"0","colnames(dirtyregressionresults) <- c(""ActiveName"", ""Model"", ""F1"", ""Kd1"", ""Kd2"", ""NA"", ""RMSE"", ""IC50"")"
"0",""
"0","#Graph Function"
"0","temptext <- paste(ActiveName, ""Dirty Biphasic Regression"", sep = "" "")"
"0","biphasic.results <- paste(""BiphasicModel: "", ""F1="", round(a, digits = 8) , "", Kd1="", round(b, digits = 8), "", Kd2="", round(c, digits = 8), "" Offset="", d, "", RMSE="", round(RMSE, digits = 8), "", IC50="", round(IC50, digits = 8), sep = """")"
"0","log_breaks(n = 5, base = 10)"
"0","ggplot(data = testdata, aes(x = x, y = y)) +"
"0","  geom_point()+"
"0","  geom_function(fun = biphasic.function, na.rm = TRUE)+ "
"0","  labs(title = temptext, x = ""LnCONC"", y = ""Relative Viability"") +"
"0","  annotate(geom = ""text"", x = max(x), y = 1.3, label = str_wrap(biphasic.results, 16)) +"
"0","  scale_x_continuous(trans = ""log10"", limits = c(NA, 100))+"
"0","  ylim(0, 1.5)+"
"0","  ggsave(plot = last_plot(), filename = paste(ActiveName,""_Dirty_Biphasic_Plot.png"", sep = """"), width = 10, height = 10, device = NULL)"
"0","}"
"0","}"
"1","[1]"
"1"," ""MC-CAR_32"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_51"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_52"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_59"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_86"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_1"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_41"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_53"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_54"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_110"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_45"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_106"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_119"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_11"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_55"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_62"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_63"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_111"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_60"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_83"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_87"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_5"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_17"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_56"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_64"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_9"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_94"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_104"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_89"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_3"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_35"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_37"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_91"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_30"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_34"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_38"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_6"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_29"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_71"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_88"""
"1","
"
"1","[1]"
"1"," ""MC-CAR_127"""
"1","
"
"0","output_results <- dirtyregressionresults"
"0","colnames(output_results) <- c(""ActiveName"", ""Model"", ""F1"", ""Kd1"", ""Kd2"", ""NA"", ""RMSE"", ""IC50"")"
"0","output_results <- rbind(output_results, dirtyregressionresults)"
"0","write.csv(output_results, file = ""all_results.csv"")"
"0",""
"0","#dirtyregressionresults <- dirtyregressionresults[!is.na(IC50)]"
"0","#dirtyregressionresults <- distinct(dirtyregressionresults, .keep_all = FALSE)"
"0",""
